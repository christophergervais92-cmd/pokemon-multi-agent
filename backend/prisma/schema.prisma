generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  phone         String?
  name          String
  passwordHash  String    @map("password_hash")
  avatarUrl     String?   @map("avatar_url")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  addresses      Address[]
  orders         Order[]
  favorites      Favorite[]
  paymentMethods PaymentMethod[]
  reviews        Review[]

  @@map("users")
}

model Address {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  label       String   // "Home", "Work", etc.
  street      String
  apartment   String?
  city        String
  state       String
  zipCode     String   @map("zip_code")
  latitude    Float?
  longitude   Float?
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model PaymentMethod {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  stripeMethodId String   @map("stripe_method_id")
  type           String   // "card", "apple_pay"
  last4          String
  brand          String?
  isDefault      Boolean  @default(false) @map("is_default")
  createdAt      DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

model Restaurant {
  id              String   @id @default(uuid())
  name            String
  description     String?
  imageUrl        String?  @map("image_url")
  coverImageUrl   String?  @map("cover_image_url")
  category        String
  rating          Float    @default(0)
  reviewCount     Int      @default(0) @map("review_count")
  deliveryTimeMin Int      @map("delivery_time_min")
  deliveryTimeMax Int      @map("delivery_time_max")
  deliveryFee     Decimal  @map("delivery_fee") @db.Decimal(10, 2)
  minimumOrder    Decimal  @default(0) @map("minimum_order") @db.Decimal(10, 2)
  latitude        Float
  longitude       Float
  address         String
  isOpen          Boolean  @default(true) @map("is_open")
  openingTime     String?  @map("opening_time")
  closingTime     String?  @map("closing_time")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  menuItems  MenuItem[]
  orders     Order[]
  favorites  Favorite[]
  reviews    Review[]

  @@map("restaurants")
}

model MenuItem {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String
  description  String?
  price        Decimal  @db.Decimal(10, 2)
  imageUrl     String?  @map("image_url")
  category     String
  isAvailable  Boolean  @default(true) @map("is_available")
  isPopular    Boolean  @default(false) @map("is_popular")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant  Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  options     MenuItemOption[]
  orderItems  OrderItem[]

  @@map("menu_items")
}

model MenuItemOption {
  id         String   @id @default(uuid())
  menuItemId String   @map("menu_item_id")
  name       String   // "Size", "Toppings"
  type       String   // "single", "multiple"
  required   Boolean  @default(false)
  maxSelect  Int?     @map("max_select")

  menuItem MenuItem           @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  choices  MenuItemOptionChoice[]

  @@map("menu_item_options")
}

model MenuItemOptionChoice {
  id       String  @id @default(uuid())
  optionId String  @map("option_id")
  name     String
  price    Decimal @default(0) @db.Decimal(10, 2)

  option MenuItemOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@map("menu_item_option_choices")
}

model Favorite {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  restaurantId String   @map("restaurant_id")
  createdAt    DateTime @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@map("favorites")
}

model Order {
  id                String      @id @default(uuid())
  userId            String      @map("user_id")
  restaurantId      String      @map("restaurant_id")
  driverId          String?     @map("driver_id")
  status            OrderStatus @default(PENDING)
  subtotal          Decimal     @db.Decimal(10, 2)
  deliveryFee       Decimal     @map("delivery_fee") @db.Decimal(10, 2)
  serviceFee        Decimal     @default(0) @map("service_fee") @db.Decimal(10, 2)
  tip               Decimal     @default(0) @db.Decimal(10, 2)
  discount          Decimal     @default(0) @db.Decimal(10, 2)
  total             Decimal     @db.Decimal(10, 2)
  deliveryAddress   Json        @map("delivery_address")
  deliveryLatitude  Float?      @map("delivery_latitude")
  deliveryLongitude Float?      @map("delivery_longitude")
  specialInstructions String?   @map("special_instructions")
  estimatedDelivery DateTime?   @map("estimated_delivery")
  stripePaymentId   String?     @map("stripe_payment_id")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id])
  restaurant Restaurant  @relation(fields: [restaurantId], references: [id])
  driver     Driver?     @relation(fields: [driverId], references: [id])
  items      OrderItem[]
  review     Review?

  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

model OrderItem {
  id              String  @id @default(uuid())
  orderId         String  @map("order_id")
  menuItemId      String  @map("menu_item_id")
  name            String
  quantity        Int
  unitPrice       Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice      Decimal @map("total_price") @db.Decimal(10, 2)
  selectedOptions Json?   @map("selected_options")
  specialNotes    String? @map("special_notes")

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}

model Driver {
  id          String   @id @default(uuid())
  name        String
  phone       String
  avatarUrl   String?  @map("avatar_url")
  vehicleType String   @map("vehicle_type")
  latitude    Float?
  longitude   Float?
  isAvailable Boolean  @default(true) @map("is_available")
  rating      Float    @default(5)
  createdAt   DateTime @default(now()) @map("created_at")

  orders Order[]

  @@map("drivers")
}

model Review {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  restaurantId String   @map("restaurant_id")
  orderId      String   @unique @map("order_id")
  rating       Int
  comment      String?
  createdAt    DateTime @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id])
  restaurant Restaurant @relation(fields: [restaurantId], references: [id])
  order      Order      @relation(fields: [orderId], references: [id])

  @@map("reviews")
}
